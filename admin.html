<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>管理后台 - BlogJetCPP</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked@4.0.10/marked.min.js"></script>
    <style>
        .admin-panel { background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        .markdown-editor { min-height: 400px; }
        .preview-pane { min-height: 400px; border: 1px solid #dee2e6; padding: 15px; }
        .footer { margin-top: 50px; padding: 20px 0; border-top: 1px solid #dee2e6; text-align: center; color: #6c757d; }
        .category-badge { background: #007bff; color: white; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.8rem; }
        .cover-image { width: 100%; height: 300px; object-fit: cover; border-radius: 8px; margin-bottom: 1rem; }
        .upload-area { border: 2px dashed #dee2e6; border-radius: 8px; padding: 20px; text-align: center; cursor: pointer; transition: border-color 0.3s; }
        .upload-area:hover { border-color: #007bff; }
        .upload-area.dragover { border-color: #007bff; background: #f8f9ff; }
        .image-preview { max-width: 100%; max-height: 200px; margin-top: 10px; border-radius: 4px; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/">BlogJetCPP</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/">首页</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/admin">管理</a>
                    </li>
                </ul>
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/logout">退出</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
    
    <div class="container mt-4">
        <div class="admin-panel">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>管理面板</h2>
                <div>
                    <a href="/admin/new" class="btn btn-primary"><i class="bi bi-plus"></i> 新建文章</a>
                    <button id="clear-cache-btn" class="btn btn-warning ms-2"><i class="bi bi-trash"></i> 清理缓存</button>
                    <a href="/admin/logout" class="btn btn-outline-secondary ms-2"><i class="bi bi-box-arrow-right"></i> 退出</a>
                </div>
            </div>
        </div>
        
        <div id="admin-content">
            <!-- 管理内容将通过 JavaScript 动态加载 -->
        </div>
    </div>
    
    <footer class="footer">
        <div class="container">
            <p>&copy; 2025 BlogJetCPP. 基于 <a href="https://github.com/dongzheyu/cfblog-plus">BlogJetCPP</a> 构建</p>
            <p><small>基于 MIT 许可证开源 - 版权所有 (c) 2025 JetCPP</small></p>
        </div>
    </footer>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 配置常量
        const CONFIG = {
            ADMIN_PASSWORD: 'DZY@013520',
            CATEGORIES: ['软件', '系统', '教程'],
            IMAGE_UPLOAD_SIZE_LIMIT: 5 * 1024 * 1024, // 5MB
            CLOUDFLARE_API_TOKEN: 'ATaK2uKHzBKMdIQBMp21ctiw0pHo8uXiBnnReS1s',
            CLOUDFLARE_ZONE_ID: '' // 需要在部署时设置
        };
        
        // 检查管理员身份
        function isAdmin() {
            return localStorage.getItem('admin_token') === 'authenticated';
        }
        
        // 验证管理员身份
        function requireAuth() {
            if (!isAdmin()) {
                window.location.href = '/admin/login';
                return false;
            }
            return true;
        }
        
        // 显示登录页面
        function showLoginPage() {
            document.getElementById('admin-content').innerHTML = `
                <div class="row justify-content-center">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h4 class="mb-0">管理员登录</h4>
                            </div>
                            <div class="card-body">
                                <form id="login-form">
                                    <div class="mb-3">
                                        <label for="password" class="form-label">密码</label>
                                        <input type="password" class="form-control" id="password" name="password" required>
                                    </div>
                                    <button type="submit" class="btn btn-primary">登录</button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('login-form').addEventListener('submit', function(e) {
                e.preventDefault();
                const password = document.getElementById('password').value;
                
                if (password === CONFIG.ADMIN_PASSWORD) {
                    localStorage.setItem('admin_token', 'authenticated');
                    loadAdminPanel();
                } else {
                    alert('密码错误');
                }
            });
        }
        
        // 加载管理面板
        async function loadAdminPanel() {
            if (!requireAuth()) return;
            
            try {
                const response = await fetch('https://raw.githubusercontent.com/dongzheyu/cfblog-plus/master/posts.json');
                const posts = await response.json();
                
                document.getElementById('admin-content').innerHTML = `
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>标题</th>
                                    <th>分类</th>
                                    <th>创建时间</th>
                                    <th>更新时间</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${posts.map(post => `
                                    <tr>
                                        <td>
                                            ${post.title}
                                            ${post.cover_image ? '<i class="bi bi-image text-muted ms-1" title="有封面图片"></i>' : ''}
                                        </td>
                                        <td>${post.category || '<span class="text-muted">未分类</span>'}</td>
                                        <td>${new Date(post.created_at).toLocaleDateString('zh-CN')}</td>
                                        <td>${post.updated_at ? new Date(post.updated_at).toLocaleDateString('zh-CN') : '-'}</td>
                                        <td>
                                            <a href="/admin/edit/${post.slug}" class="btn btn-sm btn-outline-primary"><i class="bi bi-pencil"></i> 编辑</a>
                                            <button onclick="deletePost('${post.slug}')" class="btn btn-sm btn-outline-danger"><i class="bi bi-trash"></i> 删除</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            } catch (error) {
                console.error('从 main 分支加载文章失败:', error);
                
                // 尝试使用 master 分支作为后备方案
                console.log('尝试使用 master 分支...');
                try {
                    const response = await fetch('https://raw.githubusercontent.com/dongzheyu/cfblog-plus/master/posts.json');
                    const posts = await response.json();
                    
                    document.getElementById('admin-content').innerHTML = `
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>标题</th>
                                        <th>分类</th>
                                        <th>创建时间</th>
                                        <th>更新时间</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${posts.map(post => `
                                        <tr>
                                            <td>
                                                ${post.title}
                                                ${post.cover_image ? '<i class="bi bi-image text-muted ms-1" title="有封面图片"></i>' : ''}
                                            </td>
                                            <td>${post.category || '<span class="text-muted">未分类</span>'}</td>
                                            <td>${new Date(post.created_at).toLocaleDateString('zh-CN')}</td>
                                            <td>${post.updated_at ? new Date(post.updated_at).toLocaleDateString('zh-CN') : '-'}</td>
                                            <td>
                                                <a href="/admin/edit/${post.slug}" class="btn btn-sm btn-outline-primary"><i class="bi bi-pencil"></i> 编辑</a>
                                                <button onclick="deletePost('${post.slug}')" class="btn btn-sm btn-outline-danger"><i class="bi bi-trash"></i> 删除</button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                } catch (fallbackError) {
                    console.error('从 master 分支加载文章也失败:', fallbackError);
                    document.getElementById('admin-content').innerHTML = '<p class="text-muted">加载文章失败，请检查网络连接或联系管理员。</p>';
                }
            }
        }
        
        // 删除文章
        async function deletePost(slug) {
            if (!requireAuth()) return;
            
            if (confirm('确定要删除这篇文章吗？此操作不可恢复。')) {
                try {
                    // 这里需要调用后端 API 删除文章
                    const response = await fetch(`/admin/delete/${slug}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': 'Bearer ' + localStorage.getItem('admin_token')
                        }
                    });
                    
                    if (response.ok) {
                        alert('文章已删除');
                        loadAdminPanel(); // 重新加载面板
                        await clearCloudflareCache(); // 清理缓存
                    } else {
                        alert('删除失败');
                    }
                } catch (error) {
                    console.error('删除文章失败:', error);
                    alert('删除失败');
                }
            }
        }
        
        // 清理 Cloudflare 缓存
        async function clearCloudflareCache() {
            if (!CONFIG.CLOUDFLARE_ZONE_ID) {
                console.warn('未设置 Cloudflare Zone ID，跳过缓存清理');
                return;
            }
            
            try {
                const response = await fetch(`https://api.cloudflare.com/client/v4/zones/${CONFIG.CLOUDFLARE_ZONE_ID}/purge_cache`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${CONFIG.CLOUDFLARE_API_TOKEN}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        purge_everything: true
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    console.log('Cloudflare 缓存清理成功');
                } else {
                    console.error('Cloudflare 缓存清理失败:', result.errors);
                }
            } catch (error) {
                console.error('清理 Cloudflare 缓存时出错:', error);
            }
        }
        
        // 页面加载时检查身份并显示相应内容
        document.addEventListener('DOMContentLoaded', function() {
            // 为清理缓存按钮添加事件监听器
            document.getElementById('clear-cache-btn').addEventListener('click', async function() {
                if (confirm('确定要清理全站缓存吗？')) {
                    await clearCloudflareCache();
                    alert('缓存清理完成！');
                }
            });
            
            // 检查是否已登录
            if (isAdmin()) {
                loadAdminPanel();
            } else {
                showLoginPage();
            }
        });
        
        // 编辑器相关功能
        function showEditor(post = null) {
            if (!requireAuth()) return;
            
            document.getElementById('admin-content').innerHTML = `
                <div class="admin-panel">
                    <h2>${post ? '编辑文章' : '新建文章'}</h2>
                </div>
                
                <form id="post-form">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="mb-3">
                                <label for="title" class="form-label">标题</label>
                                <input type="text" class="form-control" id="title" name="title" value="${post ? post.title : ''}" required>
                            </div>
                            
                            <div class="mb-3">
                                <label for="category" class="form-label">分类</label>
                                <select class="form-select" id="category" name="category">
                                    <option value="">请选择分类</option>
                                    ${CONFIG.CATEGORIES.map(cat => `
                                        <option value="${cat}" ${post && post.category === cat ? 'selected' : ''}>${cat}</option>
                                    `).join('')}
                                </select>
                            </div>
                            
                            <div class="mb-3">
                                <label for="summary" class="form-label">摘要</label>
                                <textarea class="form-control" id="summary" name="summary" rows="2">${post ? post.summary || '' : ''}</textarea>
                            </div>
                            
                            <div class="mb-3">
                                <label for="cover_image" class="form-label">封面图片</label>
                                <div class="upload-area" onclick="document.getElementById('cover_image').click()" 
                                     ondrop="handleDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
                                    <i class="bi bi-cloud-upload" style="font-size: 2rem; color: #6c757d;"></i>
                                    <p class="mt-2 mb-0">点击或拖拽上传封面图片</p>
                                    <small class="text-muted">支持 JPG、PNG、GIF 格式，最大 5MB</small>
                                    <input type="file" id="cover_image" name="cover_image" accept="image/*" style="display: none;" onchange="handleCoverImageSelect(event)">
                                    <div id="cover_preview" class="mt-2">
                                        ${post && post.cover_image ? `<img src="${post.cover_image}" class="image-preview" alt="封面预览">` : ''}
                                    </div>
                                </div>
                                <input type="hidden" id="cover_image_url" name="cover_image_url" value="${post ? post.cover_image || '' : ''}">
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0">图片上传</h6>
                                </div>
                                <div class="card-body">
                                    <div class="upload-area" onclick="document.getElementById('image_upload').click()" 
                                         ondrop="handleImageDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
                                        <i class="bi bi-image" style="font-size: 1.5rem; color: #6c757d;"></i>
                                        <p class="mt-2 mb-0">上传图片到内容</p>
                                        <small class="text-muted">点击或拖拽上传</small>
                                        <input type="file" id="image_upload" accept="image/*" style="display: none;" onchange="handleImageUpload(event)">
                                    </div>
                                    <div id="uploaded_images" class="mt-2"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="content" class="form-label">内容 (Markdown)</label>
                        <div class="row">
                            <div class="col-md-6">
                                <textarea class="form-control markdown-editor" id="content" name="content" rows="15" oninput="updatePreview()">${post ? post.content : ''}</textarea>
                            </div>
                            <div class="col-md-6">
                                <div class="preview-pane" id="preview">${post ? marked.parse(post.content) : ''}</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <button type="submit" class="btn btn-primary">${post ? '更新文章' : '发布文章'}</button>
                        <a href="/admin" class="btn btn-outline-secondary">取消</a>
                    </div>
                </form>
            `;
            
            // 为表单添加提交事件监听器
            document.getElementById('post-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const formData = {
                    title: document.getElementById('title').value,
                    content: document.getElementById('content').value,
                    summary: document.getElementById('summary').value,
                    category: document.getElementById('category').value,
                    cover_image: document.getElementById('cover_image_url').value,
                    slug: post ? post.slug : generateSlug(document.getElementById('title').value),
                    created_at: post ? post.created_at : new Date().toISOString(),
                    updated_at: new Date().toISOString()
                };
                
                try {
                    let response;
                    if (post) {
                        // 更新文章
                        response = await fetch(`/admin/update/${post.slug}`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': 'Bearer ' + localStorage.getItem('admin_token')
                            },
                            body: JSON.stringify(formData)
                        });
                    } else {
                        // 创建文章
                        response = await fetch('/admin/create', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': 'Bearer ' + localStorage.getItem('admin_token')
                            },
                            body: JSON.stringify(formData)
                        });
                    }
                    
                    if (response.ok) {
                        alert(post ? '文章更新成功' : '文章发布成功');
                        await clearCloudflareCache(); // 清理缓存
                        window.location.href = '/admin';
                    } else {
                        alert(post ? '更新失败' : '发布失败');
                    }
                } catch (error) {
                    console.error(post ? '更新文章失败' : '发布文章失败', error);
                    alert(post ? '更新失败' : '发布失败');
                }
            });
        }
        
        // 辅助函数
        function generateSlug(title) {
            return title.toLowerCase()
                .replace(/[^\w\s-]/g, '')
                .replace(/\s+/g, '-')
                .replace(/-+/g, '-')
                .trim();
        }
        
        function updatePreview() {
            const content = document.getElementById('content').value;
            document.getElementById('preview').innerHTML = marked.parse(content);
        }
        
        function handleDragOver(event) {
            event.preventDefault();
            event.currentTarget.classList.add('dragover');
        }
        
        function handleDragLeave(event) {
            event.currentTarget.classList.remove('dragover');
        }
        
        function handleDrop(event) {
            event.preventDefault();
            event.currentTarget.classList.remove('dragover');
        }
        
        async function handleCoverImageSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!file.type.startsWith('image/')) {
                alert('请选择图片文件');
                return;
            }
            
            if (file.size > CONFIG.IMAGE_UPLOAD_SIZE_LIMIT) {
                alert('图片大小不能超过 5MB');
                return;
            }
            
            // 这里需要上传图片到服务器
            alert('在完整实现中，这里会上传图片到服务器');
        }
        
        let uploadedImageUrls = [];
        
        async function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!file.type.startsWith('image/')) {
                alert('请选择图片文件');
                return;
            }
            
            if (file.size > CONFIG.IMAGE_UPLOAD_SIZE_LIMIT) {
                alert('图片大小不能超过 5MB');
                return;
            }
            
            // 这里需要上传图片到服务器
            alert('在完整实现中，这里会上传图片到服务器');
            event.target.value = '';
        }
        
        function handleImageDrop(event) {
            event.preventDefault();
            event.currentTarget.classList.remove('dragover');
            
            const files = event.dataTransfer.files;
            if (files.length > 0) {
                document.getElementById('image_upload').files = files;
                handleImageUpload({ target: { files: files } });
            }
        }
        
        function updateUploadedImages() {
            const container = document.getElementById('uploaded_images');
            container.innerHTML = uploadedImageUrls.map(url => `
                <div class="mb-2">
                    <img src="${url}" class="image-preview" style="max-width: 100px; max-height: 80px;">
                    <button type="button" class="btn btn-sm btn-outline-danger ms-2" onclick="removeImage('${url}')">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            `).join('');
        }
        
        function removeImage(url) {
            uploadedImageUrls = uploadedImageUrls.filter(u => u !== url);
            updateUploadedImages();
        }
        
        function insertImageToContent(url) {
            const content = document.getElementById('content');
            const cursorPos = content.selectionStart;
            const textBefore = content.value.substring(0, cursorPos);
            const textAfter = content.value.substring(cursorPos);
            const imageMarkdown = `![](${url})`;
            
            content.value = textBefore + imageMarkdown + textAfter;
            content.selectionStart = content.selectionEnd = cursorPos + imageMarkdown.length;
            content.focus();
            updatePreview();
        }
    </script>
</body>
</html>